name: Build PixelOS for Redmi K60 (mondrian)

on:
  workflow_dispatch:
    inputs:
      device:
        description: 'Device codename'
        required: true
        default: 'mondrian'
      rom_type:
        description: 'ROM type'
        required: true
        default: 'pixelos'
        type: choice
        options:
          - pixelos
          - lineageos
          - aosp
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'

env:
  DEVICE: ${{ github.event.inputs.device || 'mondrian' }}
  ROM_TYPE: ${{ github.event.inputs.rom_type || 'pixelos' }}
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_SIZE: 50G

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Clean disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h
      
      - name: Setup Git config
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global core.autocrlf false
      
      - name: Install repo tool
        run: |
          mkdir -p ~/.bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/.bin/repo
          chmod a+x ~/.bin/repo
          echo "$HOME/.bin" >> $GITHUB_PATH
      
      - name: Create working directory
        run: |
          mkdir -p ${{ github.workspace }}/rom
          cd ${{ github.workspace }}/rom
      
      - name: Step 1: Install necessary tools and dependencies
        run: |
          cd ${{ github.workspace }}/rom
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jdk git-core gnupg flex bison gperf build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z-dev libgl1-mesa-dev libxml2-utils xsltproc unzip ccache bc rsync libxml2 libxslt1.1 libssl-dev liblz4-tool imagemagick
      
      - name: Step 2: Sync PixelOS ROM using Repo
        run: |
          cd ${{ github.workspace }}/rom
          
          mkdir -p ${{ github.workspace }}/logs
          
          if [ "$ROM_TYPE" = "pixelos" ]; then
            ~/.bin/repo init -u https://github.com/PixelOS-AOSP/manifest.git -b sixteen --git-lfs 2>&1 | tee ${{ github.workspace }}/logs/repo-init.log
          elif [ "$ROM_TYPE" = "lineageos" ]; then
            ~/.bin/repo init -u https://github.com/LineageOS/android.git -b lineage-21 --git-lfs 2>&1 | tee ${{ github.workspace }}/logs/repo-init.log
          else
            ~/.bin/repo init -u https://android.googlesource.com/platform/manifest -b android-14.0.0 --git-lfs 2>&1 | tee ${{ github.workspace }}/logs/repo-init.log
          fi
          
          ~/.bin/repo sync -c -j4 --force-sync --no-clone-bundle --no-tags --prune 2>&1 | tee ${{ github.workspace }}/logs/repo-sync.log
      
      - name: Step 3: Download device-specific source code
        run: |
          cd ${{ github.workspace }}/rom
          
          git clone https://github.com/LineageOS/android_device_xiaomi_mondrian device/xiaomi/mondrian
          git clone https://github.com/LineageOS/android_device_xiaomi_sm8475-common device/xiaomi/sm8475-common
          git clone https://github.com/LineageOS/android_vendor_xiaomi_mondrian vendor/xiaomi/mondrian
          git clone https://github.com/LineageOS/android_kernel_xiaomi_sm8450 kernel/xiaomi/mondrian
          git clone https://github.com/LineageOS/android_kernel_xiaomi_sm8450-modules kernel/xiaomi/sm8450-modules
          git clone https://github.com/LineageOS/android_kernel_xiaomi_sm8450-devicetrees kernel/xiaomi/sm8450-devicetrees
          git clone https://github.com/LineageOS/android_device_xiaomi_sepolicy device/xiaomi/sepolicy
      
      - name: Setup ccache
        run: |
          echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV
          echo "USE_CCACHE=1" >> $GITHUB_ENV
          echo "CCACHE_EXEC=$(which ccache)" >> $GITHUB_ENV
          ccache -M $CCACHE_SIZE
          ccache -z
      
      - name: Step 4: Build the ROM
        run: |
          cd ${{ github.workspace }}/rom
          
          source build/envsetup.sh
          lunch pixelos_mondrian-userdebug
          mka bacon -j$(nproc --all)
      
      - name: Show ccache statistics
        run: |
          ccache -s
      
      - name: Step 5: Locate the built ROM
        run: |
          cd ${{ github.workspace }}/rom
          find . -name "*.zip" -type f | head -20
          find out/target/product/$DEVICE -name "*.img" -type f | head -20
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pixelos-${{ env.DEVICE }}-${{ github.run_number }}
          path: |
            ${{ github.workspace }}/rom/out/target/product/${{ env.DEVICE }}/*.zip
            ${{ github.workspace }}/rom/out/target/product/${{ env.DEVICE }}/*.img
          retention-days: 30
          if-no-files-found: warn
      
      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_number }}
          path: |
            ${{ github.workspace }}/rom/out/build.log
            ${{ github.workspace }}/rom/out/error.log
            ${{ github.workspace }}/logs/repo-init.log
            ${{ github.workspace }}/logs/repo-sync.log
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Cleanup
        if: always()
        run: |
          echo "Build complete!"
          df -h