name: Build PixelOS for Redmi K60 (mondrian)

on:
  workflow_dispatch:
    inputs:
      device:
        description: '设备代号'
        required: true
        default: 'mondrian'
      rom_type:
        description: 'ROM 类型'
        required: true
        default: 'pixelos'
        type: choice
        options:
          - pixelos
          - lineageos
          - aosp
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'  # 每周日 UTC 0:00 自动编译

env:
  DEVICE: ${{ github.event.inputs.device || 'mondrian' }}
  ROM_TYPE: ${{ github.event.inputs.rom_type || 'pixelos' }}
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_SIZE: 50G

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: 清理磁盘空间
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h
      
      - name: 设置 Git 配置
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global core.autocrlf false
      
      - name: 安装 repo 工具
        run: |
          mkdir -p ~/.bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/.bin/repo
          chmod a+x ~/.bin/repo
          echo "$HOME/.bin" >> $GITHUB_PATH
      
      - name: 创建工作目录
        run: |
          mkdir -p ${{ github.workspace }}/rom
          cd ${{ github.workspace }}/rom
      
      - name: Step 1: 安装必要的工具和依赖
        run: |
          cd ${{ github.workspace }}/rom
          
          sudo apt-get update
          sudo apt-get install -y \
            openjdk-17-jdk \
            git-core \
            gnupg \
            flex \
            bison \
            gperf \
            build-essential \
            zip \
            curl \
            zlib1g-dev \
            gcc-multilib \
            g++-multilib \
            libc6-dev-i386 \
            lib32ncurses5-dev \
            x11proto-core-dev \
            libx11-dev \
            lib32z-dev \
            libgl1-mesa-dev \
            libxml2-utils \
            xsltproc \
            unzip \
            ccache \
            bc \
            rsync \
            libxml2 \
            libxslt1.1 \
            libssl-dev \
            liblz4-tool \
            imagemagick
      
      - name: Step 2: 使用 Repo 同步 PixelOS ROM
        run: |
          cd ${{ github.workspace }}/rom
          
          mkdir -p ${{ github.workspace }}/logs
          
          if [ "$ROM_TYPE" = "pixelos" ]; then
            ~/.bin/repo init -u https://github.com/PixelOS-AOSP/manifest.git -b sixteen --git-lfs 2>&1 | tee ${{ github.workspace }}/logs/repo-init.log
          elif [ "$ROM_TYPE" = "lineageos" ]; then
            ~/.bin/repo init -u https://github.com/LineageOS/android.git -b lineage-21 --git-lfs 2>&1 | tee ${{ github.workspace }}/logs/repo-init.log
          else
            ~/.bin/repo init -u https://android.googlesource.com/platform/manifest -b android-14.0.0 --git-lfs 2>&1 | tee ${{ github.workspace }}/logs/repo-init.log
          fi
          
          ~/.bin/repo sync -c -j4 --force-sync --no-clone-bundle --no-tags --prune 2>&1 | tee ${{ github.workspace }}/logs/repo-sync.log
      
      - name: Step 3: 下载设备专用源代码
        run: |
          cd ${{ github.workspace }}/rom
          
          # Device Tree
          git clone https://github.com/LineageOS/android_device_xiaomi_mondrian device/xiaomi/mondrian
          
          # Common Device Code
          git clone https://github.com/LineageOS/android_device_xiaomi_sm8475-common device/xiaomi/sm8475-common
          
          # Vendor
          git clone https://github.com/LineageOS/android_vendor_xiaomi_mondrian vendor/xiaomi/mondrian
          
          # Kernel
          git clone https://github.com/LineageOS/android_kernel_xiaomi_sm8450 kernel/xiaomi/mondrian
          
          # Kernel Modules
          git clone https://github.com/LineageOS/android_kernel_xiaomi_sm8450-modules kernel/xiaomi/sm8450-modules
          
          # Kernel Device Trees
          git clone https://github.com/LineageOS/android_kernel_xiaomi_sm8450-devicetrees kernel/xiaomi/sm8450-devicetrees
          
          # Sepolicy
          git clone https://github.com/LineageOS/android_device_xiaomi_sepolicy device/xiaomi/sepolicy
      
      - name: 设置 ccache
        run: |
          echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV
          echo "USE_CCACHE=1" >> $GITHUB_ENV
          echo "CCACHE_EXEC=$(which ccache)" >> $GITHUB_ENV
          ccache -M $CCACHE_SIZE
          ccache -z
      
      - name: Step 4: 构建 ROM
        run: |
          cd ${{ github.workspace }}/rom
          
          source build/envsetup.sh
          lunch pixelos_mondrian-userdebug
          mka bacon -j$(nproc --all)
      
      - name: 显示 ccache 统计
        run: |
          ccache -s
      
      - name: Step 5: 查找已构建的 ROM
        run: |
          cd ${{ github.workspace }}/rom
          find . -name "*.zip" -type f | head -20
          find out/target/product/$DEVICE -name "*.img" -type f | head -20
      
      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: pixelos-${{ env.DEVICE }}-${{ github.run_number }}
          path: |
            ${{ github.workspace }}/rom/out/target/product/${{ env.DEVICE }}/*.zip
            ${{ github.workspace }}/rom/out/target/product/${{ env.DEVICE }}/*.img
          retention-days: 30
          if-no-files-found: warn
      
      - name: 上传编译日志
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_number }}
          path: |
            ${{ github.workspace }}/rom/out/build.log
            ${{ github.workspace }}/rom/out/error.log
            ${{ github.workspace }}/logs/repo-init.log
            ${{ github.workspace }}/logs/repo-sync.log
          retention-days: 7
          if-no-files-found: ignore
      
      - name: 清理
        if: always()
        run: |
          echo "编译完成！"
          df -h